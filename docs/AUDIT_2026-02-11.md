# Mind Measure Mobile — Codebase Audit

**Date:** 11 February 2026  
**Commit:** `c573e745` — fix: inline all auth code - zero \_lib/ imports in critical endpoints  
**Auditor:** Automated + manual review

---

## Overall Score: 7.8 / 10

| Category                  | Score  | Trend                      |
| ------------------------- | ------ | -------------------------- |
| TypeScript Strictness     | 10/10  | ✅                         |
| CI/CD Pipeline            | 9/10   | ✅                         |
| Documentation             | 9/10   | ✅                         |
| ESLint Config             | 8/10   | ✅                         |
| Code Patterns             | 7/10   | ⚠️ In flux (auth refactor) |
| Test Coverage             | 7.5/10 | ⚠️                         |
| Security                  | 7/10   | ⚠️                         |
| Dependencies              | 7/10   | ⚠️                         |
| Bundle Size / Large Files | 6/10   | ⚠️                         |
| Dead Code                 | 6/10   | ⚠️                         |

---

## Codebase Metrics

| Metric                           | Value          |
| -------------------------------- | -------------- |
| TypeScript source files (`src/`) | 209            |
| API endpoint files (`api/`)      | 42             |
| Test files                       | 120            |
| Total lines of TypeScript        | 47,670         |
| TODO/FIXME/HACK comments         | 4 (very clean) |
| node_modules size                | 586 MB         |
| Production dependencies          | 77             |
| Dev dependencies                 | 19             |

---

## API Endpoint Health

### Working: 30 / 42 (71%)

All core mobile flow endpoints are operational:

| Endpoint                       | Status | Auth Method                     |
| ------------------------------ | ------ | ------------------------------- |
| `auth/signin`                  | ✅     | Cognito + Aurora profile lookup |
| `auth/signup`                  | ✅     | Cognito                         |
| `auth/confirm-signup`          | ✅     | Cognito                         |
| `auth/forgot-password`         | ✅     | Cognito                         |
| `auth/confirm-forgot-password` | ✅     | Cognito                         |
| `auth/refresh-token`           | ✅     | Cognito                         |
| `auth/get-user`                | ✅     | Cognito                         |
| `auth/signout`                 | ✅     | Cognito                         |
| `auth/resend-confirmation`     | ✅     | Cognito                         |
| `auth/check-email`             | ✅     | Cognito + Aurora                |
| `database/select`              | ✅     | Inline JWT decode               |
| `database/insert`              | ✅     | Inline JWT decode               |
| `database/update`              | ✅     | Inline JWT decode               |
| `database/health`              | ✅     | None (public)                   |
| `database/health-check`        | ✅     | None (public)                   |
| `assessments/history`          | ✅     | Inline JWT decode               |
| `users/profile`                | ✅     | Inline JWT decode               |
| `bedrock/analyze-text`         | ✅     | None                            |
| `rekognition/analyze-frame(s)` | ✅     | None                            |
| `storage/signed-url`           | ✅     | None                            |
| `storage/upload`               | ✅     | None                            |
| `content/track-view`           | ✅     | None                            |
| `nudges/active`                | ✅     | None                            |
| `admin/delete-article`         | ✅     | None                            |
| `universities/create-bucket`   | ✅     | None                            |

### Broken: 12 / 42 (29%) — all due to `_lib/` imports

| Endpoint                           | Broken Imports                                   | Priority                     |
| ---------------------------------- | ------------------------------------------------ | ---------------------------- |
| `lambda/finalize-session`          | cors-config                                      | **HIGH** — saves assessments |
| `generate-report`                  | cors-config                                      | **MEDIUM**                   |
| `buddies/index`                    | auth-middleware, cors-config, db                 | MEDIUM                       |
| `buddies/invite`                   | auth-middleware, cors-config, db, tokens, emails | MEDIUM                       |
| `buddies/invite/consent`           | cors-config, db, tokens                          | MEDIUM                       |
| `buddies/invite/respond`           | cors-config, db, tokens                          | MEDIUM                       |
| `buddies/invite/[inviteId]/resend` | auth-middleware, cors-config, db, tokens, emails | LOW                          |
| `buddies/invite/[inviteId]/revoke` | auth-middleware, cors-config, db                 | LOW                          |
| `buddies/[buddyId]/nudge`          | auth-middleware, cors-config, db, emails         | LOW                          |
| `buddies/[buddyId]/remove`         | auth-middleware, cors-config, db                 | LOW                          |
| `buddies/optout`                   | cors-config, db                                  | LOW                          |
| `auth/debug-auth`                  | auth-middleware (diagnostic only)                | NONE — delete                |

---

## What's Working Well

### TypeScript (10/10)

- All strict flags enabled: `strict`, `strictNullChecks`, `noImplicitAny`, `noUnusedLocals`, `noUnusedParameters`
- ~390 type errors were fixed in the recent quality overhaul

### CI/CD (9/10)

- GitHub Actions pipeline: typecheck → lint → format → unit tests → build → E2E
- Husky pre-commit hooks with lint-staged (Prettier + ESLint)
- Vitest for unit tests, Playwright for E2E

### Documentation (9/10)

- 13 docs files including USER_FLOW_SPECIFICATION, PRIVACY_COMPLIANCE_ARCHITECTURE
- Architecture Decision Records (ADRs) maintained
- Buddy system fully documented

### Auth Flow (Fixed Today)

- Sign-in → Cognito auth → Aurora profile lookup → tokens + profile returned
- Client stores tokens in Capacitor Preferences
- MobileAppWrapper routes based on `hasCompletedBaseline`
- Database confirmed: 104 fusion outputs, 26 assessment sessions for test user

---

## What Needs Work

### 1. `_lib/` Bundling Issue (Critical)

**Root cause:** Vercel's serverless bundler fails to properly include files from `api/_lib/` at runtime. Any endpoint importing from `_lib/` crashes with `FUNCTION_INVOCATION_FAILED`.

**Impact:** 12 of 42 endpoints broken.

**Fix applied:** Core endpoints (select, insert, update, history, profile) were rewritten with inlined auth code and zero `_lib/` imports.

**Remaining:** 12 endpoints still need fixing (buddy system, finalize-session, generate-report).

### 2. Large Files (6/10)

19 files exceed 400 lines. Top offenders:

| File                       | Lines |
| -------------------------- | ----- |
| `MobileConversation.tsx`   | 1,045 |
| `HelpPage.tsx`             | 915   |
| `AWSBrowserService.ts`     | 782   |
| `MobileDashboard.tsx`      | 753   |
| `CheckinAssessmentSDK.tsx` | 732   |
| `cms/data.ts`              | 689   |
| `useBaselineAssessment.ts` | 671   |

### 3. Console Logging (Noisy)

`useBaselineAssessment.ts` has **67** console statements. Top files:

- `useBaselineAssessment.ts`: 67
- `cms/data.ts`: 34
- `CheckinAssessmentSDK.tsx`: 24
- `cognito-api-client.ts`: 18

### 4. Dead Code in `api/_lib/`

- `cognito-auth.ts` — created today, no longer imported (superseded by inline auth)
- `db-query.ts` — not imported by any endpoint
- `auth-middleware.ts` — only used by broken buddy endpoints (will be replaced)
- `cors-config.ts` — only used by broken endpoints (will be replaced)

### 5. Missing `.env.example`

No `.env.example` file exists, making onboarding and deployment configuration error-prone.

### 6. Inconsistent API Patterns

Three different patterns in use:

1. **Inline auth + pg** (new, working) — `signin`, `history`, `select`, etc.
2. **auth-middleware + cors-config** (old, broken in Vercel) — buddy endpoints
3. **BackendServiceFactory** (legacy) — `login.ts`, `register.ts`

---

## Priority Roadmap

### Immediate (Next Session)

1. Fix `lambda/finalize-session` — inline CORS (saves assessment results)
2. Fix buddy system — 9 endpoints need inline auth + CORS
3. Fix `generate-report` — inline CORS
4. Delete `auth/debug-auth` and `auth/debug-db` (diagnostic, no longer needed)

### Short Term (This Week)

5. Delete dead `_lib/` files (`cognito-auth.ts`, `db-query.ts`)
6. Create `.env.example`
7. Reduce console logging in `useBaselineAssessment.ts`
8. Split `MobileConversation.tsx` (1,045 lines)

### Medium Term

9. Standardize all API endpoints on one pattern
10. Add test coverage for large components
11. Audit Radix UI dependency usage (24 packages)
12. Add bundle size monitoring to CI

---

## Session Changes Summary (10 Feb 2026)

### Problem

Mobile app couldn't log in — returning users not recognised. Serverless functions crashing with `FUNCTION_INVOCATION_FAILED` due to Vercel ESM runtime incompatibility with `_lib/` imports.

### Root Causes Identified

1. `api/_lib/auth-middleware.ts` imports `jsonwebtoken` + `jwks-rsa` (CJS modules) which crash in Vercel's ESM runtime
2. ALL `api/_lib/` imports crash serverless functions (bundler issue)
3. Client sends ID tokens but `GetUserCommand` only accepts access tokens
4. `signin.ts` didn't fetch user profile from Aurora (couldn't identify returning users)
5. `MobileAppWrapper` trusted stale device preferences over auth state

### Fixes Applied

- `signin.ts`: Added Aurora profile + baseline lookup by email after Cognito auth
- `history.ts`, `select.ts`, `insert.ts`, `update.ts`, `profile.ts`: Rewritten with inline JWT decode auth (accepts both ID and access tokens) and inline CORS — zero `_lib/` imports
- `MobileAppWrapper.tsx`: Auth state prioritised over device preferences
- `AuthContext.tsx`: Saves user profile to device after sign-in
- `cognito-api-client.ts`: Handles non-JSON responses, Cognito challenges, profile data from Aurora

### Data Integrity Confirmed

- User profile: Keith Duddy, keith@mindmeasure.co.uk, university: Worcester
- 104 fusion outputs (check-ins) intact
- 26 assessment sessions intact
- `hasCompletedBaseline: true`

---

_Next audit scheduled after buddy system fix is complete._
